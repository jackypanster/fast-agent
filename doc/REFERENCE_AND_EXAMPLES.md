# Platform Agent - å‡½æ•°å‚è€ƒå’Œä½¿ç”¨ç¤ºä¾‹

æœ¬æ–‡æ¡£æä¾›äº† Platform Agent ç³»ç»Ÿä¸­ä¸»è¦å‡½æ•°ã€ç±»å’Œæ–¹æ³•çš„è¯¦ç»†å‚è€ƒï¼Œå¹¶é™„å¸¦äº†å…·ä½“çš„ä½¿ç”¨ç¤ºä¾‹ï¼Œä»¥å¸®åŠ©å¼€å‘è€…å’Œç”¨æˆ·ç†è§£å’Œä½¿ç”¨è¯¥ç³»ç»Ÿã€‚

## 1. å‡½æ•°ä¸æ–¹æ³•å‚è€ƒ

### 1.1. `src/main.py`

---

#### `main()`

- **åŠŸèƒ½æ¦‚è¿°**:
  åº”ç”¨ç¨‹åºçš„ä¸»å…¥å£å‡½æ•°ï¼Œè´Ÿè´£å¯åŠ¨å’Œç®¡ç†äº¤äº’å¼å‘½ä»¤è¡Œç•Œé¢ (CLI)ã€‚
- **è¾“å…¥å‚æ•°**: æ— ã€‚
- **è¾“å‡ºç»“æœ**: æ— ã€‚è¯¥å‡½æ•°ä¼šæŒç»­è¿è¡Œï¼Œç›´åˆ°ç”¨æˆ·è¾“å…¥ `exit` æˆ– `quit`ã€‚
- **å†…éƒ¨é€»è¾‘**:
  1.  æ‰“å°æ¬¢è¿ä¿¡æ¯ã€‚
  2.  æ£€æŸ¥ `OPENROUTER_API_KEY` ç¯å¢ƒå˜é‡æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™æŠ¥é”™å¹¶é€€å‡ºã€‚
  3.  è¿›å…¥ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œç­‰å¾…ç”¨æˆ·è¾“å…¥ã€‚
  4.  æ•è·ç”¨æˆ·è¾“å…¥ï¼Œå¹¶å»é™¤é¦–å°¾ç©ºæ ¼ã€‚
  5.  å¦‚æœè¾“å…¥æ˜¯é€€å‡ºå‘½ä»¤ (`exit`, `quit`, `q`)ï¼Œåˆ™ç»“æŸå¾ªç¯ã€‚
  6.  å¦‚æœè¾“å…¥ä¸ºç©ºï¼Œåˆ™è·³è¿‡æœ¬æ¬¡å¾ªç¯ã€‚
  7.  è°ƒç”¨ `ops_crew.crew.run_crew()` å‡½æ•°å¤„ç†ç”¨æˆ·è¾“å…¥ã€‚
  8.  æ‰“å° `run_crew()` è¿”å›çš„ç»“æœã€‚
- **å¼‚å¸¸å¤„ç†**:
  - `KeyboardInterrupt`: ç”¨æˆ·æŒ‰ä¸‹ `Ctrl+C` æ—¶ï¼Œä¼˜é›…åœ°é€€å‡ºç¨‹åºã€‚
  - `Exception`: æ•è·å…¶ä»–æ‰€æœ‰å¼‚å¸¸ï¼Œå¹¶æ‰“å°é”™è¯¯ä¿¡æ¯ï¼Œé˜²æ­¢ç¨‹åºå´©æºƒã€‚

### 1.2. `src/tool_inspector.py`

---

#### `refresh_cache() -> Dict`

- **åŠŸèƒ½æ¦‚è¿°**:
  å¼ºåˆ¶è§¦å‘ MCP å·¥å…·å‘ç°æµç¨‹ï¼Œå¹¶åˆ·æ–°æœ¬åœ°çš„ `tools_cache.json` ç¼“å­˜æ–‡ä»¶ã€‚
- **è¾“å…¥å‚æ•°**: æ— ã€‚
- **è¾“å‡ºç»“æœ**:
  - `Dict`: å¦‚æœç¼“å­˜æˆåŠŸï¼Œè¿”å›ä¸€ä¸ªåŒ…å«æ–°ç¼“å­˜å†…å®¹çš„å­—å…¸ã€‚å¦‚æœå¤±è´¥ï¼Œåˆ™è¿”å›ä¸€ä¸ªç©ºå­—å…¸ã€‚
- **å†…éƒ¨é€»è¾‘**:
  1.  å®ä¾‹åŒ– `OpsCrew`ã€‚
  2.  è·å– `discovery_crew`ã€‚
  3.  è°ƒç”¨ `discovery_crew.kickoff()` å¯åŠ¨å·¥å…·å‘ç°ä»»åŠ¡ã€‚
  4.  æ‰“å°å‘ç°ç»“æœã€‚
  5.  è¯»å–æ–°ç”Ÿæˆçš„ `tools_cache.json` æ–‡ä»¶å¹¶è¿”å›å…¶å†…å®¹ã€‚
- **å¼‚å¸¸å¤„ç†**:
  - `Exception`: æ•è·åœ¨å·¥å…·å‘ç°è¿‡ç¨‹ä¸­å¯èƒ½å‘ç”Ÿçš„ä»»ä½•é”™è¯¯ï¼Œå¹¶æ‰“å°é”™è¯¯ä¿¡æ¯ã€‚

---

#### `check_cache_status()`

- **åŠŸèƒ½æ¦‚è¿°**:
  æ£€æŸ¥å¹¶æ˜¾ç¤ºå½“å‰ `tools_cache.json` ç¼“å­˜æ–‡ä»¶çš„çŠ¶æ€ã€‚
- **è¾“å…¥å‚æ•°**: æ— ã€‚
- **è¾“å‡ºç»“æœ**: æ— ã€‚ç›´æ¥åœ¨æ§åˆ¶å°æ‰“å°ç¼“å­˜çŠ¶æ€ä¿¡æ¯ã€‚
- **å†…éƒ¨é€»è¾‘**:
  1.  æ£€æŸ¥ `tools_cache.json` æ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€‚
  2.  å¦‚æœå­˜åœ¨ï¼Œåˆ™è¯»å–æ–‡ä»¶å†…å®¹ï¼Œè§£æå‡º `fetched_at` (ä¸Šæ¬¡æ›´æ–°æ—¶é—´) å’Œ `tools` åˆ—è¡¨ã€‚
  3.  è®¡ç®—ç¼“å­˜çš„â€œå¹´é¾„â€ï¼ˆageï¼‰ã€‚
  4.  è°ƒç”¨ `_should_refresh_cache()` åˆ¤æ–­ç¼“å­˜æ˜¯å¦â€œé™ˆæ—§â€ï¼ˆstaleï¼‰ã€‚
  5.  æ‰“å°è¯¦ç»†çš„çŠ¶æ€ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ›´æ–°æ—¶é—´ã€å¹´é¾„ã€å·¥å…·æ•°é‡ä»¥åŠæ˜¯å¦é™ˆæ—§ã€‚
- **å¼‚å¸¸å¤„ç†**:
  - `json.JSONDecodeError`, `KeyError`, `ValueError`: å¦‚æœç¼“å­˜æ–‡ä»¶æŸåæˆ–æ ¼å¼ä¸æ­£ç¡®ï¼Œåˆ™æ•è·å¼‚å¸¸å¹¶æç¤ºç”¨æˆ·è¿è¡Œ `--refresh`ã€‚

---

#### `list_cached_tools()`

- **åŠŸèƒ½æ¦‚è¿°**:
  è¯¦ç»†åˆ—å‡º `tools_cache.json` ä¸­æ‰€æœ‰å·²ç¼“å­˜çš„å·¥å…·åŠå…¶ä¿¡æ¯ã€‚
- **è¾“å…¥å‚æ•°**: æ— ã€‚
- **è¾“å‡ºç»“æœ**: æ— ã€‚ç›´æ¥åœ¨æ§åˆ¶å°æ‰“å°å·¥å…·åˆ—è¡¨ã€‚
- **å†…éƒ¨é€»è¾‘**:
  1.  æ£€æŸ¥ `tools_cache.json` æ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€‚
  2.  è¯»å–å¹¶è§£æç¼“å­˜æ–‡ä»¶ã€‚
  3.  ä¸ºäº†æ›´å¥½åœ°ç»„ç»‡è¾“å‡ºï¼Œå°†å·¥å…·æŒ‰å…¶åç§°å‰ç¼€ï¼ˆå¦‚ `k8s`, `git` ç­‰ï¼‰è¿›è¡Œåˆ†ç»„ã€‚
  4.  éå†åˆ†ç»„åçš„å·¥å…·ï¼Œæ‰“å°æ¯ä¸ªå·¥å…·çš„åç§°ã€æè¿°å’Œå¿…è¦çš„å‚æ•°ã€‚

---

#### `main()` (in `tool_inspector.py`)

- **åŠŸèƒ½æ¦‚è¿°**:
  `tool_inspector.py` è„šæœ¬çš„ CLI è§£æå’Œæ‰§è¡Œå…¥å£ã€‚
- **å†…éƒ¨é€»è¾‘**:
  1.  ä½¿ç”¨ `argparse` å®šä¹‰å’Œè§£æå‘½ä»¤è¡Œå‚æ•° (`--refresh`, `--check`, `--list`)ã€‚
  2.  æ ¹æ®ç”¨æˆ·æä¾›çš„å‚æ•°ï¼Œä¾æ¬¡è°ƒç”¨ `refresh_cache()`, `check_cache_status()`, `list_cached_tools()` ç­‰å‡½æ•°ã€‚
  3.  å¦‚æœæ²¡æœ‰æä¾›ä»»ä½•å‚æ•°ï¼Œåˆ™æ‰“å°å¸®åŠ©ä¿¡æ¯ã€‚

### 1.3. `src/ops_crew/crew.py`

---

#### `OpsCrew` (class)

- **åŠŸèƒ½æ¦‚è¿°**:
  ä¸€ä¸ªåŸºäº `crewai.CrewBase` çš„ç±»ï¼Œç”¨äºå®šä¹‰å’Œç»„ç»‡æ•´ä¸ªç³»ç»Ÿçš„ Agentã€Task å’Œ Crewã€‚
- **å…³é”®å±æ€§**:
  - `agents_config`: `config/agents.yaml` æ–‡ä»¶çš„è·¯å¾„ã€‚
  - `tasks_config`: `config/tasks.yaml` æ–‡ä»¶çš„è·¯å¾„ã€‚
  - `mcp_server_params`: MCP æœåŠ¡å™¨çš„é…ç½®ä¿¡æ¯ã€‚
  - `llm`: å…¨å±€çš„å¤§è¯­è¨€æ¨¡å‹å®ä¾‹ï¼ˆLLMï¼‰ã€‚
- **å…³é”®æ–¹æ³•**:
  - `@agent tool_inspector()`: åˆ›å»ºå¹¶è¿”å›ä¸€ä¸ª `tool_inspector` Agent å®ä¾‹ï¼Œè¯¥ Agent å¯ä»¥è®¿é—®æ‰€æœ‰ MCP å·¥å…·ã€‚
  - `@agent k8s_expert()`: åˆ›å»ºå¹¶è¿”å›ä¸€ä¸ª `k8s_expert` Agent å®ä¾‹ï¼Œè¯¥ Agent åªèƒ½è®¿é—®ä»ç¼“å­˜ä¸­æ™ºèƒ½ç­›é€‰å‡ºçš„ k8s ç›¸å…³å·¥å…·ã€‚
  - `@task tool_discovery_task()`: åˆ›å»ºå¹¶è¿”å›ä¸€ä¸ªç”¨äºå·¥å…·å‘ç°çš„ä»»åŠ¡ã€‚
  - `@task k8s_analysis_task()`: åˆ›å»ºå¹¶è¿”å›ä¸€ä¸ªç”¨äºåˆ†æç”¨æˆ· k8s è¯·æ±‚çš„ä»»åŠ¡ã€‚
  - `@crew discovery_crew()`: åˆ›å»ºå¹¶è¿”å›ä¸€ä¸ªä»…åŒ…å« `tool_inspector` Agent å’Œ `tool_discovery_task` çš„ Crewï¼Œä¸“é—¨ç”¨äºå·¥å…·å‘ç°ã€‚
  - `@crew ops_crew()`: åˆ›å»ºå¹¶è¿”å›ä¸»æ“ä½œ Crewï¼ŒåŒ…å« `k8s_expert` Agent å’Œ `k8s_analysis_task`ï¼Œå¹¶é…ç½®äº†åŸºäº Qwen è¯å‘é‡çš„è®°å¿†ç³»ç»Ÿã€‚

---

#### `_should_refresh_cache() -> bool`

- **åŠŸèƒ½æ¦‚è¿°**:
  ä¸€ä¸ªè¾…åŠ©å‡½æ•°ï¼Œç”¨äºåˆ¤æ–­ `tools_cache.json` æ˜¯å¦éœ€è¦åˆ·æ–°ã€‚
- **è¾“å…¥å‚æ•°**: æ— ã€‚
- **è¾“å‡ºç»“æœ**:
  - `bool`: å¦‚æœç¼“å­˜æ–‡ä»¶ä¸å­˜åœ¨ã€æŸåï¼Œæˆ–è·ç¦»ä¸Šæ¬¡æ›´æ–°æ—¶é—´è¶…è¿‡ 24 å°æ—¶ï¼Œåˆ™è¿”å› `True`ï¼›å¦åˆ™è¿”å› `False`ã€‚
- **å‰ç½®æ¡ä»¶**: æ— ã€‚

---

#### `_load_cached_tools()`

- **åŠŸèƒ½æ¦‚è¿°**:
  ä» `tools_cache.json` æ–‡ä»¶ä¸­æ™ºèƒ½åŠ è½½å’Œç­›é€‰å·¥å…·ã€‚
- **è¾“å…¥å‚æ•°**: æ— ã€‚
- **è¾“å‡ºç»“æœ**:
  - `List[Tool]`: è¿”å›ä¸€ä¸ª `crewai` å·¥å…·å¯¹è±¡åˆ—è¡¨ã€‚
- **å†…éƒ¨é€»è¾‘**:
  1.  å¦‚æœç¼“å­˜æ–‡ä»¶ä¸å­˜åœ¨æˆ–æŸåï¼Œåˆ™å›é€€åˆ°åŠ è½½æ‰€æœ‰å¯ç”¨çš„ MCP å·¥å…·ã€‚
  2.  è¯»å–ç¼“å­˜æ–‡ä»¶ï¼Œæå–æ‰€æœ‰å·¥å…·ã€‚
  3.  ç­›é€‰å‡ºåç§°ä»¥ä¸‹åˆ—å‰ç¼€å¼€å¤´çš„å·¥å…·ï¼š`list_`, `get_`, `describe_`ã€‚
  4.  å¦‚æœç­›é€‰å‡ºå·¥å…·ï¼Œåˆ™åªåŠ è½½è¿™äº›å·¥å…·ï¼›å¦åˆ™ï¼Œå›é€€åˆ°åŠ è½½æ‰€æœ‰å·¥å…·ã€‚
- **åç½®æ¡ä»¶**: è¿”å›çš„å·¥å…·åˆ—è¡¨å°†ç”¨äºåˆå§‹åŒ– `k8s_expert` Agentã€‚

---

#### `run_crew(user_input: str) -> str`

- **åŠŸèƒ½æ¦‚è¿°**:
  è®¾ç½®å¹¶è¿è¡Œ Ops Crew ä»¥å¤„ç†ç”¨æˆ·çš„è¯·æ±‚ï¼Œæ˜¯è¿æ¥ `main.py` å’Œ `crew.py` çš„æ¡¥æ¢ã€‚
- **è¾“å…¥å‚æ•°**:
  - `user_input` (`str`): ç”¨æˆ·è¾“å…¥çš„åŸå§‹é—®é¢˜æˆ–æŒ‡ä»¤ã€‚
- **è¾“å‡ºç»“æœ**:
  - `str`: Crew æ‰§è¡Œåè¿”å›çš„æœ€ç»ˆç»“æœã€‚
- **å†…éƒ¨é€»è¾‘**:
  1.  å®ä¾‹åŒ– `OpsCrew`ã€‚
  2.  è°ƒç”¨ `_should_refresh_cache()` æ£€æŸ¥ç¼“å­˜çŠ¶æ€ã€‚å¦‚æœéœ€è¦ï¼Œåˆ™è¿è¡Œ `discovery_crew` æ¥åˆ·æ–°ç¼“å­˜ã€‚
  3.  è·å– `ops_crew`ã€‚
  4.  å°† `user_input` æ ¼å¼åŒ–åˆ° `k8s_analysis_task` çš„ä»»åŠ¡æè¿°ä¸­ã€‚
  5.  è°ƒç”¨ `main_crew.kickoff()` å¯åŠ¨ä¸»ä»»åŠ¡æµç¨‹ã€‚
  6.  è¿”å›æ‰§è¡Œç»“æœã€‚
- **å¼‚å¸¸å¤„ç†**:
  - `Exception`: æ•è·æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä»»ä½•é”™è¯¯ï¼Œå¹¶è¿”å›æ ¼å¼åŒ–çš„é”™è¯¯ä¿¡æ¯ã€‚

## 2. ä½¿ç”¨ç¤ºä¾‹

### 2.1. è¿è¡Œäº¤äº’å¼ Platform Agent

```bash
# ç¡®ä¿ä½ çš„ .env æ–‡ä»¶å·²é…ç½®å¥½ OPENROUTER_API_KEY
# è¿è¡Œä¸»ç¨‹åº
python src/main.py
```

**ç¤ºä¾‹å¯¹è¯:**

```
ğŸš€ Welcome to the Platform Agent!
Type 'exit' or 'quit' to end the session.
==================================================
ğŸ¤– Platform Agent > Please list all pods in the default namespace.

ğŸ” Processing your request...
==================================================
... (Agent æ‰§è¡Œè¿‡ç¨‹çš„æ—¥å¿—è¾“å‡º) ...
==================================================

ğŸ“‹ Result:
==================================================
Here is a list of all pods in the 'default' namespace:
- pod-A (Running)
- pod-B (Completed)
- pod-C (Running)
==================================================
ğŸ¤– Platform Agent > describe pod-A

... (Agent å¤„ç†æ–°è¯·æ±‚) ...
```

### 2.2. ä½¿ç”¨ `tool_inspector.py` ç®¡ç†å·¥å…·ç¼“å­˜

#### å¼ºåˆ¶åˆ·æ–°ç¼“å­˜

å¦‚æœä½ åˆšåˆšåœ¨ MCP æœåŠ¡å™¨ä¸Šæ·»åŠ äº†ä¸€ä¸ªæ–°å·¥å…·ï¼Œæˆ–è€…æ€€ç–‘ç¼“å­˜å·²æŸåï¼Œå¯ä»¥å¼ºåˆ¶åˆ·æ–°ã€‚

```bash
python src/tool_inspector.py --refresh
```

**è¾“å‡ºç¤ºä¾‹:**

```
ğŸ”§ MCP Tool Inspector
==================================================
ğŸ” Forcing tool discovery and cache refresh...
âœ… Tool discovery completed: Successfully discovered and cached 25 tools.
ğŸ“‹ Successfully cached 25 tools
```

#### æ£€æŸ¥ç¼“å­˜çŠ¶æ€

æ£€æŸ¥ç¼“å­˜æ˜¯å¦æœ€æ–°ã€‚

```bash
python src/tool_inspector.py --check
```

**è¾“å‡ºç¤ºä¾‹:**

```
ğŸ”§ MCP Tool Inspector
==================================================
ğŸ“‹ Cache Status:
   ğŸ“… Last updated: 2023-10-27 10:30:00
   â° Age: 0:15:30.123456
   ğŸ”§ Tools cached: 25
   ğŸŸ¢ FRESH (24h threshold)
```

#### åˆ—å‡ºæ‰€æœ‰ç¼“å­˜çš„å·¥å…·

æŸ¥çœ‹å½“å‰ Agent å¯ä»¥ä½¿ç”¨çš„æ‰€æœ‰å·¥å…·ã€‚

```bash
python src/tool_inspector.py --list
```

**è¾“å‡ºç¤ºä¾‹:**

```
ğŸ”§ MCP Tool Inspector
==================================================
ğŸ“‹ Cached Tools (25 total):
================================================================================

ğŸ”§ K8S Tools:
   â€¢ k8s_list_pods
     ğŸ“ List all pods in a given Kubernetes namespace.
     ğŸ“‹ Required params: namespace

   â€¢ k8s_get_pod_logs
     ğŸ“ Get logs from a specific pod.
     ğŸ“‹ Required params: namespace, pod_name

... (å…¶ä»–å·¥å…·) ...
